<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>أسماك الرشيدي — منيو</title>
<style>
  /* --- صفحة أنيقة للكتاب والمنيو --- */
  :root{
    --bg:#050507; --card:#0f1114; --accent:#c9a36b; --muted:#9aa0a6;
  }
  *{box-sizing:border-box;font-family:system-ui,'Segoe UI',Tahoma,'Noto Sans Arabic',sans-serif}
  body{margin:0;min-height:100vh;background:linear-gradient(180deg,#050507,#0b0c0f);color:#fff;display:flex;align-items:center;justify-content:center;padding:30px}
  .container{width:100%;max-width:1100px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  header h1{color:var(--accent);font-size:28px;margin:0}
  .adminBtn{background:transparent;border:0;color:#fff;font-size:26px;cursor:pointer;padding:6px 10px;border-radius:8px}
  /* book */
  .bookScene{perspective:2000px;width:100%;height:560px;display:flex;align-items:center;justify-content:center}
  .book{width:760px;height:520px;position:relative;transform-style:preserve-3d}
  .cover{
    position:absolute;width:100%;height:100%;left:0;top:0;
    cursor:pointer;box-shadow:0 40px 80px rgba(0,0,0,0.7);
    transform-origin:left;transition:transform 1s cubic-bezier(.22,.9,.32,1);
    transform-style: preserve-3d;
    z-index: 10;
  }
  .cover-front, .cover-back {
    position: absolute;
    width: 100%; height: 100%;
    backface-visibility: hidden;
    border-radius: 12px;
  }
  .cover-front {
    background: linear-gradient(135deg,#141414,#2b2b2b);
    display: flex; 
    align-items: center; /* تغيير لمحاذاة المحتوى في المنتصف عمودياً */
    justify-content: center;
    padding: 40px;
    text-align: center; /* لضمان محاذاة النص في المنتصف */
  }
  .cover-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px; /* مسافة بين الشعار والتفاصيل */
  }
  .cover-front img {
    max-width: 80%; /* تصغير الشعار قليلاً لإفساح المجال للنص */
    max-height: 250px; /* تحديد ارتفاع أقصى */
    object-fit: contain;
  }
  .cover-details {
    color: var(--muted);
    font-size: 16px;
  }
  .cover-details p {
    margin: 5px 0;
  }
  .cover-details .phone {
    color: var(--accent);
    font-weight: bold;
    font-size: 18px;
  }
  .cover-back {
    background: #1f1f1f; transform: rotateY(180deg);
  }
  /* عند فتح الكتاب، الغلاف يختفي للخلف */
  .book.open .cover{transform:rotateY(-180deg); z-index: 0;}

  .back-cover {
    position: absolute;
    width: 100%; height: 100%;
    left: 0; top: 0;
    background: linear-gradient(135deg,#141414,#2b2b2b);
    border-radius: 12px;
    z-index: -1; /* يكون في الخلف دائمًا */
  }

  /* الحلقات الذهبية */
  .book-rings {
    position: absolute;
    top: 0;
    left: 18px; /* تعديل موضع الحلقات الذهبية */
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-evenly; /* توزيع متساوٍ */
    padding: 40px 0; /* حشوة علوية وسفلية */
    z-index: 100; /* فوق كل شيء */
    pointer-events: none; /* حتى لا تعترض طريق الماوس */
  }
  .ring {
    width: 30px; /* عرض قطعة السلك */
    height: 8px; /* سماكة السلك */
    background: linear-gradient(to right, #a27b41, #f0e2b6, #a27b41); /* تدرج لوني ذهبي معدني */
    border-radius: 4px; /* حواف دائرية */
    box-shadow: 1px 1px 5px rgba(0,0,0,0.5); /* ظل ناعم لإعطاء عمق */
    transform: translateX(-24px); /* سحب الحلقة للخارج لتبدو بارزة */
  }

  .page{position:absolute;top:0;left:0;width:100%;height:100%;backface-visibility:hidden;transform-origin:left;transition:transform 900ms cubic-bezier(.22,.9,.32,1);transform-style:preserve-3d; border-radius: 12px;}
  .page-front, .page-back {position:absolute;inset:0;padding:28px;backface-visibility:hidden;display:flex;flex-direction:column}
  .page-front{background:var(--card); box-shadow: inset 7px 0 15px -7px rgba(0,0,0,0.5);} /* ظل داخلي أغمق */
  .page-back{background:var(--card);transform:rotateY(180deg); box-shadow: inset 7px 0 15px -7px rgba(0,0,0,0.5);} /* ظل داخلي أغمق */
  .page.dragging {
    transition: none; /* إلغاء الانتقال أثناء السحب للحصول على استجابة فورية */
    cursor: grabbing;
  }
  .page h2{margin:0 0 8px 0;color:#c9a36b; position: relative; z-index: 1;} /* z-index to ensure title is above grid */
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-top:10px}
  .card{background:rgba(0,0,0,0.03);padding:10px;border-radius:10px;display:flex;gap:10px;align-items:center}
  .card img{width:120px;height:80px;object-fit:cover;border-radius:8px; background: #333;} /* خلفية داكنة للصور قبل التحميل */
  .card .meta{flex:1; color: var(--muted);} /* تغيير لون الوصف ليكون أفتح */
  .price{color:var(--accent);font-weight:700}
  .controls{position:fixed;right:18px;bottom:18px;display:flex;gap:8px}
  /* Admin controls on cards */
  .card-admin-controls{display:none; gap:6px; margin-top:8px;}
  body.admin-mode .card-admin-controls{display:flex;}
  .card-admin-controls button{font-size:12px; padding:4px 8px; border-radius:6px; cursor:pointer; border:0; background:rgba(0,0,0,0.08);}
  .card-admin-controls .delete-btn{background:#ff4d4d;color:#fff}
  .btn{background:rgba(255,255,255,0.06);border:0;padding:10px 12px;border-radius:8px;color:var(--muted);cursor:pointer; user-select: none;}
  /* popup styles */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:9999}
  .panel{background:#161616;padding:18px;border-radius:12px;width:360px;box-shadow:0 20px 60px rgba(0,0,0,0.8)}
  input,select,textarea{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:0;background:#222;color:#fff}
  label{color:#ddd;font-size:13px;margin-top:8px;display:block}
  .small{font-size:13px;color:#aaa;margin-top:8px}
  .danger{background:#ff4d4d;color:#111}
  footer.small{margin-top:10px;color:#888;font-size:12px}
  .controls { display: none; } /* إخفاء أزرار التحكم القديمة */
  @media (max-width:880px){ .book{width:92vw;height:62vh} .grid{grid-template-columns:1fr} .card img{width:90px;height:70px} .panel{width:92vw} }
  /* Helper classes */
  .pos-relative{position:relative}
  .flex-gap{display:flex;gap:8px;margin-top:12px}
  .item-name{font-weight:700; color: #e0e0e0;} /* لون فاتح لاسم الصنف */
  #pwToggle{position:absolute;left:10px;top:50%;transform:translateY(-50%);cursor:pointer;user-select:none;}
  .spinner { border: 3px solid rgba(255,255,255,0.2); border-top-color: var(--accent); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display:none; margin: 0 8px; } @keyframes spin { to { transform: rotate(360deg); } }</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>أسماك الرشيدي</h1>
      <button class="adminBtn" id="adminBtn" title="إدارة">⋮</button>
    </header>

    <div class="bookScene">
      <div class="book" id="book">
        <div class="cover" id="cover">
          <div class="cover-front">
            <div class="cover-content">
              <img src="images/logo.png" alt="شعار أسماك الرشيدي" />
              <div class="cover-details">
                <p class="address" id="coverAddress">جاري تحميل العنوان...</p>
                <p class="phone" id="coverPhone">جاري تحميل الرقم...</p>
              </div>
            </div>
          </div>
          <div class="cover-back"></div>
        </div>
        <div class="book-rings">
          <div class="ring"></div>
          <div class="ring"></div>
          <div class="ring"></div>
          <div class="ring"></div>
          <div class="ring"></div>
        </div>
        <div class="back-cover"></div>
        <!-- الصفحات ستضاف هنا مباشرة بواسطة JavaScript -->
      </div>
    </div>

    <div class="controls">
      <button class="btn" id="prevBtn">الصفحة السابقة</button>
      <button class="btn" id="nextBtn">الصفحة التالية</button>
    </div>
  </div>

  <!-- Overlay: password prompt -->
  <div class="overlay" id="passwordOverlay">
    <div class="panel">
      <h3>أدخل كلمة المرور</h3>
      <div class="pos-relative">
        <input type="password" id="pwInput" placeholder="كلمة المرور">
        <span id="pwToggle">👁️</span>
      </div>
      <label class="small">مطلوب للتحكم — يمكنك تعديل الـ hash في الكود</label>
      <div class="flex-gap">
        <button class="btn" id="pwSubmit">دخول</button>
        <button class="btn" id="pwCancel">إلغاء</button>
      </div>
      <hr style="margin-top:12px;border:none;border-top:1px solid rgba(255,255,255,0.04)">
      <button class="btn" id="forgotPwBtn" style="width:100%; background:transparent; color:#aaa; font-size:13px;">نسيت كلمة المرور؟</button>
      <div class="small">لو نجحت ستستطيع رفع صور وصنف جديد. ستطلب الصفحة بعد ذلك الـ GitHub Token (مرة واحدة).</div>
    </div>
  </div>

  <!-- Overlay: admin upload -->
  <div class="overlay" id="adminOverlay">
    <div class="panel">
      <h3>إضافة صنف جديد</h3>

      <label>الفئة</label>
      <input id="catInput" placeholder="مثال: اسماك">

      <label>اسم الصنف</label>
      <input id="nameInput" placeholder="اسم الصنف">

      <label>السعر</label>
      <input id="priceInput" placeholder="السعر">

      <label>الوصف</label>
      <textarea id="descInput" placeholder="وصف (اختياري)"></textarea>

      <label>الصورة (سيتم رفعها إلى الريبو)</label>
      <input type="file" id="imgInput" accept="image/*">

      <label class="small">أدخل GitHub Personal Access Token (سيُخزن مؤقتًا في المتصفح فقط)</label>
      <input id="tokenInput" placeholder="ghp_xxx... (أدخل التوكن هنا مرة واحدة)">

      <div class="flex-gap">
        <button class="btn" id="uploadBtn">إضافة ورفع</button>
        <button class="btn danger" id="closeAdminBtn">إلغاء</button>
        <button class="btn" id="editInfoBtn" style="background:#334;" title="تعديل العنوان/الهاتف">ℹ️</button>
        <!-- زر الخروج من وضع المدير -->
        <button class="btn" id="changePwBtn" style="background:#334;" title="تغيير كلمة المرور">🔑</button>
        <button class="btn" id="logoutAdminBtn" style="background:#555;">خروج</button>

      </div>

      <footer class="small">ملاحظة: التوكن مطلوب للكتابة في الريبو؛ صلاحية repo كافية. بعد الاستخدام يمكنك مسحه من إعدادات GitHub.</footer>
    </div>
  </div>

  <!-- Overlay: edit item -->
  <div class="overlay" id="editOverlay">
    <div class="panel">
      <h3>تعديل صنف</h3>
      <input type="hidden" id="editIdInput">

      <label>الفئة</label>
      <input id="editCatInput" placeholder="مثال: اسماك">

      <label>اسم الصنف</label>
      <input id="editNameInput" placeholder="اسم الصنف">

      <label>السعر</label>
      <input id="editPriceInput" placeholder="السعر">

      <label>الوصف</label>
      <textarea id="editDescInput" placeholder="وصف (اختياري)"></textarea>

      <div class="small">ملاحظة: تعديل الصورة يتطلب حذف الصنف وإضافته من جديد.</div>

      <div class="flex-gap">
        <button class="btn" id="saveEditBtn">حفظ التعديلات</button>
        <button class="btn danger" id="closeEditBtn">إلغاء</button>
      </div>
    </div>
  </div>

  <!-- Overlay: change password -->
  <div class="overlay" id="changePwOverlay">
    <div class="panel">
      <h3>تغيير كلمة المرور</h3>
      <div class="small">لتأمين حسابك، سنرسل رمز تحقق إلى حسابك في تيليجرام.</div>
      
      <div class="flex-gap">
        <button class="btn" id="sendCodeBtn">إرسال رمز التحقق</button>
        <div id="sendCodeSpinner" class="spinner"></div>
      </div>

      <label for="verificationCodeInput">رمز التحقق</label>
      <input id="verificationCodeInput" placeholder="أدخل الرمز من تيليجرام">

      <label for="newPasswordInput">كلمة المرور الجديدة</label>
      <input type="password" id="newPasswordInput" placeholder="أدخل كلمة المرور الجديدة">

      <div class="flex-gap">
        <button class="btn" id="updatePasswordBtn">تحديث كلمة المرور</button>
        <div id="updatePwSpinner" class="spinner"></div>
        <button class="btn danger" id="closeChangePwBtn">إلغاء</button>
      </div>
    </div>
  </div>

  <!-- Overlay: forgot password -->
  <div class="overlay" id="forgotPwOverlay">
    <div class="panel">
      <h3>إعادة تعيين كلمة المرور</h3>
      <div class="small">لإعادة التعيين، يجب إدخال GitHub Token الخاص بك لإثبات الملكية، ثم طلب رمز تحقق سيصلك على تيليجرام.</div>

      <label>GitHub Personal Access Token</label>
      <input id="forgotPwTokenInput" placeholder="ghp_xxx...">

      <div class="flex-gap">
        <button class="btn" id="forgotPwSendCodeBtn">إرسال رمز التحقق</button>
        <div id="forgotPwSendCodeSpinner" class="spinner"></div>
      </div>

      <label>رمز التحقق</label>
      <input id="forgotPwVerificationCodeInput" placeholder="أدخل الرمز من تيليجرام">

      <label>كلمة المرور الجديدة</label>
      <input type="password" id="forgotPwNewPasswordInput" placeholder="أدخل كلمة المرور الجديدة">

      <div class="flex-gap">
        <button class="btn" id="resetPasswordBtn">إعادة تعيين</button>
        <div id="resetPwSpinner" class="spinner"></div>
        <button class="btn danger" id="closeForgotPwBtn">إلغاء</button>
      </div>
    </div>
  </div>

  <!-- Overlay: edit info -->
  <div class="overlay" id="infoOverlay">
    <div class="panel">
      <h3>تعديل معلومات التواصل</h3>

      <label>العنوان</label>
      <input id="infoAddressInput" placeholder="مثال: 📍 العنوان: شارع ...">

      <label>رقم الهاتف</label>
      <input id="infoPhoneInput" placeholder="مثال: 📞 للتواصل: 012...">

      <div class="flex-gap">
        <button class="btn" id="saveInfoBtn">حفظ المعلومات</button>
        <button class="btn danger" id="closeInfoBtn">إلغاء</button>
      </div>
    </div>
  </div>

  <!-- عنصر الصوت لقلب الصفحات -->
  <audio id="flipSound" src="audio/page-flip.mp3" preload="auto"></audio>

<script>
/* ================== إعدادات ريبّو ================== */
const GITHUB_OWNER = 'farok6799';
const GITHUB_REPO  = 'Rashedy-Menu';
const GITHUB_BRANCH = 'main'; // أو 'master' لو بتستخدمه
const MENU_JSON_PATH = 'menu.json';
const INFO_JSON_PATH = 'info.json';
const IMAGES_FOLDER = 'images/';

/* ============ إعداد باسورد مخزن على شكل هاش SHA-256 ============
   القيمة هنا تمثل hash('1234') بالـ SHA-256. لتغيير الباسورد:
   احسب SHA-256 لكلمة جديدة (يمكنني أديك أداة لو حبيت) وغيّر القيمة.
   current for '1234' hashed:
*/
const PASSWORD_HASH = '7f41cb340e3b6420e8274fe3e82df0dd965e4428a583299688d6d125cd1c6be3'; // sha256("1234")

/* ================== عناصر DOM ================== */
const adminBtn = document.getElementById('adminBtn');
const passwordOverlay = document.getElementById('passwordOverlay');
const adminOverlay = document.getElementById('adminOverlay');
const editOverlay = document.getElementById('editOverlay');
const infoOverlay = document.getElementById('infoOverlay');
const pwSubmit = document.getElementById('pwSubmit');
const pwCancel = document.getElementById('pwCancel');
const pwInput = document.getElementById('pwInput');
const forgotPwBtn = document.getElementById('forgotPwBtn');
const uploadBtn = document.getElementById('uploadBtn');
const closeAdminBtn = document.getElementById('closeAdminBtn');
const tokenInput = document.getElementById('tokenInput');
const logoutAdminBtn = document.getElementById('logoutAdminBtn'); // زر الخروج
const editInfoBtn = document.getElementById('editInfoBtn');
const changePwBtn = document.getElementById('changePwBtn');

const changePwOverlay = document.getElementById('changePwOverlay');
const sendCodeBtn = document.getElementById('sendCodeBtn');
const sendCodeSpinner = document.getElementById('sendCodeSpinner');
const verificationCodeInput = document.getElementById('verificationCodeInput');
const newPasswordInput = document.getElementById('newPasswordInput');
const updatePasswordBtn = document.getElementById('updatePasswordBtn');
const updatePwSpinner = document.getElementById('updatePwSpinner');
const closeChangePwBtn = document.getElementById('closeChangePwBtn');

const forgotPwOverlay = document.getElementById('forgotPwOverlay');
const forgotPwTokenInput = document.getElementById('forgotPwTokenInput');
const forgotPwSendCodeBtn = document.getElementById('forgotPwSendCodeBtn');
const forgotPwSendCodeSpinner = document.getElementById('forgotPwSendCodeSpinner');
const forgotPwVerificationCodeInput = document.getElementById('forgotPwVerificationCodeInput');
const forgotPwNewPasswordInput = document.getElementById('forgotPwNewPasswordInput');
const resetPasswordBtn = document.getElementById('resetPasswordBtn');
const resetPwSpinner = document.getElementById('resetPwSpinner');
const closeForgotPwBtn = document.getElementById('closeForgotPwBtn');

const nameInput = document.getElementById('nameInput');
const priceInput = document.getElementById('priceInput');
const descInput = document.getElementById('descInput');
const catInput = document.getElementById('catInput');
const imgInput = document.getElementById('imgInput');
const editIdInput = document.getElementById('editIdInput');
const editCatInput = document.getElementById('editCatInput');
const editNameInput = document.getElementById('editNameInput');
const editPriceInput = document.getElementById('editPriceInput');
const editDescInput = document.getElementById('editDescInput');
const saveEditBtn = document.getElementById('saveEditBtn');
const closeEditBtn = document.getElementById('closeEditBtn');
const infoAddressInput = document.getElementById('infoAddressInput');
const infoPhoneInput = document.getElementById('infoPhoneInput');
const saveInfoBtn = document.getElementById('saveInfoBtn');
const closeInfoBtn = document.getElementById('closeInfoBtn');


const bookElement = document.getElementById('book'); // تم التغيير من pagesArea إلى book
const cover = document.getElementById('cover');
const book = document.getElementById('book');
const backCover = document.querySelector('.back-cover');
const nextBtn = document.getElementById('nextBtn');
const prevBtn = document.getElementById('prevBtn');
const flipSound = document.getElementById('flipSound');
let hasSingleLastPage = false; // متغير لتتبع إذا كانت الصفحة الأخيرة فردية

let currentPageIndex = 0; // الصفحة الحالية التي ننظر إليها (0 هي الصفحة الأولى)
let pages = []; // array of category pages
let isBookOpen = false;
let isDragging = false;
let dragStartPos = 0;
let draggedPage = null;
let dragDirection = '';

/* ========== تشغيل صوت قلب الصفحة ========== */
function playFlipSound() {
    if (flipSound) {
        flipSound.currentTime = 0; // إعادة الصوت للبداية للسماح بالتشغيل المتكرر
        flipSound.play().catch(error => {
            // يتجاهل الخطأ إذا منع المتصفح التشغيل التلقائي قبل تفاعل المستخدم
            // console.log("Playback prevented until user interaction: ", error);
        });
    }
}


/* ========== مساعدة: حساب SHA-256 باستخدام Web Crypto ========= */
async function sha256(text){
  const enc = new TextEncoder();
  const data = enc.encode(text);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}

/* ========== فتح/إغلاق overlays ========== */
adminBtn.addEventListener('click', ()=> {
  if (!window.crypto || !window.crypto.subtle) {
    alert('خطأ: لا يمكن التحقق من كلمة المرور.\n\nالسبب: هذه الصفحة يجب أن تعمل من خلال خادم ويب (localhost أو https) وليس كملف مباشر.\n\nالحل: استخدم إضافة "Live Server" في VS Code لتشغيلها.');
    return;
  }
  passwordOverlay.style.display = 'flex';
});
pwCancel.addEventListener('click', ()=> passwordOverlay.style.display = 'none');

/* فتح وإغلاق لوحة "نسيت كلمة المرور" */
forgotPwBtn.addEventListener('click', () => {
  passwordOverlay.style.display = 'none';
  forgotPwOverlay.style.display = 'flex';
});
closeForgotPwBtn.addEventListener('click', () => {
  forgotPwOverlay.style.display = 'none';
});

/* تحقق من الباسورد (مقارنة هاش) */
pwSubmit.addEventListener('click', async ()=> {
  const tryHash = await sha256((pwInput.value || '').trim());
  // --- سطر التشخيص: اطبع الهاش الذي تم حسابه والهاش الصحيح للمقارنة ---
  console.log('الهاش الذي أدخلته:', tryHash, '\nالهاش الصحيح:', PASSWORD_HASH);
  if(tryHash === PASSWORD_HASH){
    passwordOverlay.style.display = 'none';
    document.body.classList.add('admin-mode'); // تفعيل وضع المدير
    alert('تم تسجيل الدخول بنجاح. أزرار التعديل والحذف ظاهرة الآن على الأصناف.');
    adminOverlay.style.display = 'flex';
    // ممكن أن نجلب التوكن من sessionStorage لو المستخدم دخله قبل كده
    tokenInput.value = sessionStorage.getItem('GHTOKEN') || '';
  } else {
    alert('كلمة المرور خطأ!');
  }
});

/* إغلاق admin */
closeAdminBtn.addEventListener('click', ()=> {
  adminOverlay.style.display = 'none';
});

/* الخروج من وضع المدير */
logoutAdminBtn.addEventListener('click', ()=> {
  adminOverlay.style.display = 'none';
  document.body.classList.remove('admin-mode'); // إزالة وضع المدير
  tokenInput.value = ''; // مسح التوكن من الحقل
  sessionStorage.removeItem('GHTOKEN'); // مسح التوكن من الـ sessionStorage
  alert('تم تسجيل الخروج من وضع المدير.');
  renderMenu(); // إعادة عرض المنيو لإخفاء أزرار التعديل/الحذف
});

/* فتح وإغلاق لوحة تغيير كلمة المرور */
changePwBtn.addEventListener('click', () => {
  changePwOverlay.style.display = 'flex';
});
closeChangePwBtn.addEventListener('click', () => {
  changePwOverlay.style.display = 'none';
});


/* إغلاق edit */
closeEditBtn.addEventListener('click', ()=> {
  editOverlay.style.display = 'none';
});

/* فتح وإغلاق لوحة تعديل المعلومات */
editInfoBtn.addEventListener('click', () => {
  loadInfoForEditing(); // تحميل البيانات الحالية في الحقول
  infoOverlay.style.display = 'flex';
});
closeInfoBtn.addEventListener('click', () => {
  infoOverlay.style.display = 'none';
});
/* إظهار/إخفاء كلمة المرور */
const pwToggle = document.getElementById('pwToggle');
pwToggle.addEventListener('click', () => {
  const isPassword = pwInput.type === 'password';
  pwInput.type = isPassword ? 'text' : 'password';
  pwToggle.textContent = isPassword ? '🙈' : '👁️';
});

/* ================= GitHub API helpers ================= */

/* تشغيل GitHub Action (workflow_dispatch) */
async function triggerWorkflow(workflowFileName, inputs, tokenOverride = null) {
    const token = tokenOverride || getAuthToken();
    if (!token) {
        throw new Error('مطلوب GitHub Token لتشغيل هذه العملية.');
    }
    
    const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/actions/workflows/${workflowFileName}/dispatches`;

    const res = await fetch(url, {
        method: 'POST',
        headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            ref: GITHUB_BRANCH,
            inputs: inputs
        })
    });

    if (res.status !== 204) { // 204 No Content is the expected success status
        const t = await res.text();
        if (res.status === 404) {
            throw new Error(`خطأ 404: لم يتم العثور على الـ Action. تأكد من وجود ملف '${workflowFileName}' في المسار الصحيح (.github/workflows/) على الفرع الرئيسي.`);
        }
        throw new Error(`خطأ في تشغيل الـ Action: ${res.status} - ${t}`);
    }
}

/* ================== منطق تغيير كلمة المرور ================== */

function generateRandomCode(length = 10) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

sendCodeBtn.addEventListener('click', async () => {
    sendCodeBtn.disabled = true;
    sendCodeSpinner.style.display = 'block';
    try {
        const code = generateRandomCode(10);
        // تخزين الرمز مؤقتًا في sessionStorage مع تاريخ انتهاء صلاحية (5 دقائق)
        const expiry = Date.now() + 5 * 60 * 1000;
        sessionStorage.setItem('verificationCode', JSON.stringify({ code, expiry }));

        await triggerWorkflow('send-telegram-code.yml', { verification_code: code });
        alert('✅ تم إرسال رمز التحقق إلى حسابك في تيليجرام. يرجى التحقق من رسائلك.');
    } catch (err) {
        console.error(err);
        alert('حدث خطأ أثناء إرسال الرمز: ' + err.message);
    } finally {
        sendCodeBtn.disabled = false;
        sendCodeSpinner.style.display = 'none';
    }
});

/* منطق "نسيت كلمة المرور" */
forgotPwSendCodeBtn.addEventListener('click', async () => {
    const token = forgotPwTokenInput.value.trim();
    if (!token) {
        return alert('يرجى إدخال GitHub Token أولاً.');
    }

    forgotPwSendCodeBtn.disabled = true;
    forgotPwSendCodeSpinner.style.display = 'block';
    try {
        const code = generateRandomCode(10);
        const expiry = Date.now() + 5 * 60 * 1000;
        sessionStorage.setItem('verificationCode', JSON.stringify({ code, expiry }));

        await triggerWorkflow('send-telegram-code.yml', { verification_code: code }, token);
        alert('✅ تم إرسال رمز التحقق إلى حسابك في تيليجرام.');
    } catch (err) {
        console.error(err);
        alert('حدث خطأ أثناء إرسال الرمز: ' + err.message);
    } finally {
        forgotPwSendCodeBtn.disabled = false;
        forgotPwSendCodeSpinner.style.display = 'none';
    }
});

resetPasswordBtn.addEventListener('click', async () => {
    const token = forgotPwTokenInput.value.trim();
    const storedData = JSON.parse(sessionStorage.getItem('verificationCode') || '{}');
    const enteredCode = forgotPwVerificationCodeInput.value.trim();
    const newPassword = forgotPwNewPasswordInput.value.trim();

    if (!token || !enteredCode || !newPassword) return alert('يرجى إكمال جميع الحقول: التوكن، الرمز، وكلمة المرور الجديدة.');
    if (!storedData.code || Date.now() > storedData.expiry) return alert('رمز التحقق غير صالح أو انتهت صلاحيته. اطلب رمزًا جديدًا.');
    if (enteredCode !== storedData.code) return alert('رمز التحقق غير صحيح.');

    resetPasswordBtn.disabled = true;
    resetPwSpinner.style.display = 'block';

    try {
        const newHash = await sha256(newPassword);

        const fileData = await githubGetFile('index.html', token);
        if (!fileData) throw new Error('لا يمكن قراءة ملف index.html من المستودع.');

        let fileContent = base64ToUtf8(fileData.content);
        const hashRegex = /(const PASSWORD_HASH = ')([^']+)(';)/;
        if (!hashRegex.test(fileContent)) throw new Error('لم يتم العثور على متغير PASSWORD_HASH في الكود.');
        fileContent = fileContent.replace(hashRegex, `$1${newHash}$3`);

        const newBase64Content = utf8ToBase64(fileContent);
        await githubPutFile('index.html', newBase64Content, 'chore: reset password via forgot password flow', fileData.sha, token);

        alert('✅ تم إعادة تعيين كلمة المرور بنجاح! سيتم إعادة تحميل الصفحة.');
        sessionStorage.removeItem('verificationCode');
        window.location.reload();

    } catch (err) {
        console.error(err);
        alert('حدث خطأ فادح أثناء إعادة تعيين كلمة المرور: ' + err.message);
    } finally {
        resetPasswordBtn.disabled = false;
        resetPwSpinner.style.display = 'none';
    }
});

updatePasswordBtn.addEventListener('click', async () => {
    const storedData = JSON.parse(sessionStorage.getItem('verificationCode') || '{}');
    const enteredCode = verificationCodeInput.value.trim();
    const newPassword = newPasswordInput.value.trim();

    if (!enteredCode || !newPassword) return alert('يرجى إدخال رمز التحقق وكلمة المرور الجديدة.');
    if (!storedData.code || Date.now() > storedData.expiry) return alert('رمز التحقق غير صالح أو انتهت صلاحيته. يرجى طلب رمز جديد.');
    if (enteredCode !== storedData.code) return alert('رمز التحقق غير صحيح.');

    updatePasswordBtn.disabled = true;
    updatePwSpinner.style.display = 'block';

    try {
        const newHash = await sha256(newPassword);
        const token = getAuthToken();
        if (!token) throw new Error('مطلوب GitHub Token لتحديث الملف.');

        // 1. جلب الملف الحالي
        const fileData = await githubGetFile('index.html');
        if (!fileData) throw new Error('لا يمكن قراءة ملف index.html من المستودع.');

        // 2. فك تشفير المحتوى وتحديث الهاش
        let fileContent = base64ToUtf8(fileData.content);
        const hashRegex = /(const PASSWORD_HASH = ')([^']+)(';)/;
        if (!hashRegex.test(fileContent)) {
            throw new Error('لم يتم العثور على متغير PASSWORD_HASH في الكود. تأكد من أنه بنفس الصيغة.');
        }
        fileContent = fileContent.replace(hashRegex, `$1${newHash}$3`);

        // 3. إعادة تشفير المحتوى ورفعه
        const newBase64Content = utf8ToBase64(fileContent);
        await githubPutFile('index.html', newBase64Content, 'chore: update password hash', fileData.sha, token);

        alert('✅ تم تحديث كلمة المرور بنجاح! سيتم إعادة تحميل الصفحة الآن.');
        sessionStorage.removeItem('verificationCode');
        window.location.reload();

    } catch (err) {
        console.error(err);
        alert('حدث خطأ فادح أثناء تحديث كلمة المرور: ' + err.message);
    } finally {
        updatePasswordBtn.disabled = false;
        updatePwSpinner.style.display = 'none';
    }
});

/* قراءة ملف من GitHub (محتوى base64 + sha) */
async function githubGetFile(path, tokenOverride = null){
  const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodeURIComponent(path)}?ref=${GITHUB_BRANCH}`;
  const headers = {};
  // إذا تم توفير توكن، نستخدمه. هذا ضروري للوصول للمستودعات الخاصة.
  const token = tokenOverride || getAuthToken();
  if (token) {
      headers['Authorization'] = 'token ' + token;
  }
  const res = await fetch(url);
  if(res.status === 200){
    const data = await res.json();
    return data; // { content (base64), sha, path, ... }
  } else if(res.status === 404){
    return null;
  } else {
    const t = await res.text();
    throw new Error('GitHub GET error: ' + res.status + ' - ' + t);
  }
}

/* رفع/تحديث ملف إلى GitHub (يتطلب توكن) */
async function githubPutFile(path, base64content, message, sha=null, token){
  const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodeURIComponent(path)}`;
  const body = { message, content: base64content, branch: GITHUB_BRANCH };
  if(sha) body.sha = sha;
  const res = await fetch(url, {
    method:'PUT',
    headers: {
      'Authorization': 'token ' + token,
      'Accept': 'application/vnd.github.v3+json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(body)
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error('GitHub PUT error: ' + res.status + ' - ' + t);
  }
  return await res.json();
}

/* تحميل menu.json من الريبو كـ object */
async function loadMenuJson(){
  try{
    const file = await githubGetFile(MENU_JSON_PATH);
    if(!file) return [];
    const jsonString = base64ToUtf8(file.content.replace(/\n/g,'')); // فك ترميز Base64 مع دعم UTF-8
    return JSON.parse(jsonString);
  }catch(err){
    console.error(err);
    return [];
  }
}

/* تحميل info.json وعرضه */
async function loadAndRenderInfo() {
    const coverAddress = document.getElementById('coverAddress');
    const coverPhone = document.getElementById('coverPhone');
    try {
        const file = await githubGetFile(INFO_JSON_PATH);
        if (!file) throw new Error('ملف المعلومات info.json غير موجود.');
        const info = JSON.parse(base64ToUtf8(file.content.replace(/\n/g, '')));
        coverAddress.textContent = info.address || 'لا يوجد عنوان';
        coverPhone.textContent = info.phone || 'لا يوجد رقم هاتف';
    } catch (err) {
        console.error('فشل تحميل معلومات التواصل:', err);
        coverAddress.textContent = 'خطأ في تحميل العنوان';
        coverPhone.textContent = 'خطأ في تحميل الرقم';
    }
}

function createPageSideContent(category, items) {
    let gridHtml = '';
    for (const it of items) {
        const imgUrl = it.image || '';
        gridHtml += `
            <div class="card">
                <img 
                    src="${imgUrl}" 
                    alt="${escapeHtml(it.name)}" 
                    loading="lazy" 
                    onerror="this.style.display='none'"
                >
                <div class="meta">
                    <div class="item-name">${escapeHtml(it.name)}</div>
                    <div style="color:#888;font-size:13px">${escapeHtml(it.desc||'')}</div>
                    <div class="price">${escapeHtml(it.price)}</div>
                    <div class="card-admin-controls">
                        <button class="edit-btn" data-id="${escapeHtml(it.addedAt)}">تعديل</button>
                        <button class="delete-btn" data-id="${escapeHtml(it.addedAt)}">حذف</button>
                    </div>
                </div>
            </div>
        `;
    }
    return `
        <h2>${escapeHtml(category)}</h2>
        <div class="grid">${gridHtml}</div>
    `;
}

/* عرض المنيو: نقسم حسب الفئات */
async function renderMenu(){
  loadAndRenderInfo(); // تحميل العنوان والهاتف
  // إزالة الصفحات القديمة قبل إعادة البناء
  bookElement.querySelectorAll('.page').forEach(p => p.remove());
  pages = [];

  const menu = await loadMenuJson();
  
  const categories = menu.reduce((acc, item) => {
      const category = item.category || 'غير مصنف';
      if (!acc[category]) acc[category] = [];
      acc[category].push(item);
      return acc;
  }, {});
  const categoryEntries = Object.entries(categories);

  for (let i = 0; i < categoryEntries.length; i += 2) {
      const page = document.createElement('div');
      page.className = 'page';

      const [frontCat, frontItems] = categoryEntries[i];
      const frontContent = createPageSideContent(frontCat, frontItems);
      
      const backEntry = categoryEntries[i + 1];
      const backContent = backEntry ? createPageSideContent(backEntry[0], backEntry[1]) : '';

      page.innerHTML = `<div class="page-front">${frontContent}</div><div class="page-back">${backContent}</div>`;
      if (!backContent) hasSingleLastPage = true; // إذا لم يكن هناك محتوى خلفي، فهذه صفحة فردية
      bookElement.appendChild(page); // إضافة الصفحة مباشرة إلى الكتاب
      pages.push(page);
  }
  // إضافة event listeners لأزرار التعديل والحذف الجديدة
  addAdminActionListeners();

  // افتراضياً لو مفيش صفحات ابقِ الغلاف ظاهر فقط
  currentPageIndex = 0;
  applyFlipState();
}

/* ================ منطق سحب وتقليب الصفحات ================ */

// تحديد الصفحة التي يتم سحبها واتجاه السحب
function handleDragStart(e) {
    if (!isBookOpen || isDragging || !pages.length) return;

    const rect = bookElement.getBoundingClientRect();
    const clickX = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;

    // إذا كان السحب من النصف الأيسر للكتاب (للخلف)
    if (clickX < rect.width / 2) {
        if (currentPageIndex <= 0) return; // لا يمكن الرجوع من الغلاف
        dragDirection = 'prev';
        draggedPage = pages[currentPageIndex - 1]; // الصفحة المستهدفة هي آخر صفحة مقلوبة
    } 
    // إذا كان السحب من النصف الأيمن للكتاب (للأمام)
    else {
        if (currentPageIndex >= pages.length) return; // لا يمكن التقدم بعد النهاية
        dragDirection = 'next';
        draggedPage = pages[currentPageIndex]; // الصفحة المستهدفة هي الصفحة الحالية
    }

    isDragging = true;
    dragStartPos = e.touches ? e.touches[0].clientX : e.clientX;
    draggedPage.classList.add('dragging');
    e.preventDefault();

    window.addEventListener('mousemove', handleDragMove);
    window.addEventListener('touchmove', handleDragMove);
    window.addEventListener('mouseup', handleDragEnd);
    window.addEventListener('touchend', handleDragEnd);
}

// تحريك الصفحة بصريًا أثناء السحب
function handleDragMove(e) {
    if (!isDragging || !draggedPage) return;

    const currentX = e.touches ? e.touches[0].clientX : e.clientX;
    const deltaX = currentX - dragStartPos;

    if (dragDirection === 'next') {
        const rotation = Math.max(-180, Math.min(0, (deltaX / draggedPage.offsetWidth) * 180));
        draggedPage.style.transform = `rotateY(${rotation}deg)`;
    } else if (dragDirection === 'prev') {
        const rotation = Math.max(-180, Math.min(0, -180 + (deltaX / draggedPage.offsetWidth) * 180));
        draggedPage.style.transform = `rotateY(${rotation}deg)`;
    }
}

// إنهاء عملية السحب وتحديد ما إذا كان سيتم التقليب
function handleDragEnd(e) {
    if (!isDragging || !draggedPage) return;

    isDragging = false;
    draggedPage.classList.remove('dragging');

    const currentX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
    const deltaX = currentX - dragStartPos;
    const flipThreshold = draggedPage.offsetWidth / 3; // يجب أن يسحب ثلث الصفحة على الأقل

    if (dragDirection === 'next' && deltaX < -flipThreshold) {
        // أكمل التقليب للصفحة التالية
        playFlipSound();
        nextBtn.click();
    } else if (dragDirection === 'prev' && deltaX > flipThreshold) {
        // أكمل التقليب للصفحة السابقة
        playFlipSound();
        prevBtn.click();
    } else {
        // لم يتم الوصول للحد، أعد الصفحة لمكانها
        applyFlipState();
    }

    // تنظيف
    draggedPage = null;
    dragDirection = '';
    window.removeEventListener('mousemove', handleDragMove);
    window.removeEventListener('touchmove', handleDragMove);
    window.removeEventListener('mouseup', handleDragEnd);
    window.removeEventListener('touchend', handleDragEnd);
}

bookElement.addEventListener('mousedown', handleDragStart);
bookElement.addEventListener('touchstart', handleDragStart, { passive: false });


/* تعابير مساعدة */
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

/* تحكم بحالة الكتاب والصفحات (تقليب) */
function applyFlipState(){
  if (!isBookOpen) {
    book.classList.remove('open');
    book.classList.remove('end'); // تأكد من إزالته عند الإغلاق
    // عند إغلاق الكتاب، تأكد من إعادة جميع الصفحات إلى حالتها الأولية
    pages.forEach((page, i) => {
      page.style.transform = 'rotateY(0deg)';
      // إعادة ترتيب z-index لتبدو الصفحات مكدسة بشكل صحيح عند الإغلاق
      page.style.zIndex = pages.length - i; 
    });
    return;
  }

  // لم نعد بحاجة لحالة النهاية .end
  book.classList.add('open');

  const total = pages.length;
  pages.forEach((page, i) => {
    // الصفحة تُقلب إذا كان ترتيبها أقل من الصفحة الحالية المعروضة
    const isFlipped = i < currentPageIndex;

    page.style.transform = isFlipped ? 'rotateY(-180deg)' : 'rotateY(0deg)';
    
    // الصفحات المقلوبة تأخذ ترتيبًا تصاعديًا (z-index: 1, 2, 3...).
    // الصفحات غير المقلوبة تأخذ ترتيبًا تنازليًا (z-index: 5, 4, 3...).
    // هذا يضمن أن الصفحة الحالية دائمًا في الأعلى.
    page.style.zIndex = isFlipped ? i + 1 : total - i;
  });
}

/* أزرار التالي / السابق */
nextBtn.addEventListener('click', ()=> {
  if (!isBookOpen || currentPageIndex >= pages.length) return; // لا تتجاوز عدد الصفحات
  playFlipSound();
  currentPageIndex++;
  applyFlipState();
});
prevBtn.addEventListener('click', ()=> {
  if (!isBookOpen) return;
  playFlipSound();
  if (currentPageIndex > 0) {
    currentPageIndex--;
  } else { // لو كنا في الصفحة الأولى ونضغط "سابق"، نغلق الكتاب
    isBookOpen = false;
  }
  applyFlipState();
});
cover.addEventListener('click', ()=> {
  if (isBookOpen) return; // لا تفعل شيئًا إذا كان الكتاب مفتوحًا بالفعل
  playFlipSound();
  isBookOpen = true;
  applyFlipState();
});
cover.querySelector('.cover-back').addEventListener('click', (event) => {
    if (!isBookOpen) return;
    event.stopPropagation(); // Prevent click from propagating to the cover element
    currentPageIndex = 0; // إعادة التعيين للبداية
    isBookOpen = false;
    applyFlipState();
    playFlipSound();
});
backCover.addEventListener('click', () => {
    if (!isBookOpen) return; // لا تفعل شيئًا إذا كان الكتاب مغلقًا
    currentPageIndex = 0; // إعادة التعيين للبداية
    isBookOpen = false;
    applyFlipState();
    playFlipSound();
});

/* ================= Helper Functions ================= */
function getAuthToken() {
    const token = tokenInput.value.trim() || sessionStorage.getItem('GHTOKEN');
    if (token) sessionStorage.setItem('GHTOKEN', token);
    return token;
}
/* ============== رفع صورة وحدث menu.json ============== */
async function uploadItem(){
  const name = nameInput.value.trim();
  const price = priceInput.value.trim();
  const desc = descInput.value.trim();
  const category = (catInput.value.trim() || 'غير مصنف');
  const file = imgInput.files[0];
  const token = getAuthToken();

  if(!name || !price || !file){
    return alert('من فضلك اكمل الاسم والسعر واختر صورة.');
  }
  if(!token){
    return alert('مطلوب GitHub Token لرفع البيانات. يرجى إدخاله في لوحة التحكم.');
  }

  try{
    // 1) نرفع الصورة إلى images/<filename>
    const filename = makeSafeFilename(file.name);
    const targetPath = IMAGES_FOLDER + filename;

    // اقرأ الملف كـ base64
    const base64 = await fileToBase64(file); // returns base64 string without data:...
    await githubPutFile(targetPath, base64, `Add image ${filename}`, null, token);
    // بعد رفع الصورة نكوّن رابط الوصول الخام للصورة:
    const rawUrl = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${targetPath}`;

    // 2) نقرأ menu.json الحالي
    const existingFile = await githubGetFile(MENU_JSON_PATH);
    let menu = [];
    let sha = null;
    if(existingFile && existingFile.content){ // تحقق من وجود الملف ومحتواه
      sha = existingFile.sha;
      menu = JSON.parse(base64ToUtf8(existingFile.content.replace(/\n/g,'')));
    } else {
      menu = [];
    }

    // 3) نضيف العنصر الجديد
    const newItem = { name, price, desc, category, image: rawUrl, addedAt: new Date().toISOString() };
    menu.push(newItem);

    // 4) نرفع menu.json مع sha لو موجود
    const jsonString = JSON.stringify(menu, null, 2);
    await githubPutFile(MENU_JSON_PATH, utf8ToBase64(jsonString), `Add menu item ${name}`, sha, token);

    alert('✅ تم إضافة الصنف بنجاح إلى الريبو!');
    // تنظيف الحقول
    nameInput.value = priceInput.value = descInput.value = '';
    catInput.value = '';
    imgInput.value = '';
    // إعادة تحميل العرض
    await renderMenu();

  }catch(err){
    console.error(err);
    alert('حدث خطأ أثناء الرفع: ' + err.message);
  }
}

/* ================ تعديل وحذف الأصناف ================ */

function addAdminActionListeners() {
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', handleEditClick);
    });
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', handleDeleteClick);
    });
}

async function handleEditClick(event) {
    const itemId = event.target.dataset.id;
    const menu = await loadMenuJson();
    const itemToEdit = menu.find(item => item.addedAt === itemId);

    if (!itemToEdit) {
        alert('لم يتم العثور على الصنف!');
        return;
    }

    // ملء نافذة التعديل بالبيانات الحالية
    editIdInput.value = itemToEdit.addedAt;
    editCatInput.value = itemToEdit.category || '';
    editNameInput.value = itemToEdit.name || '';
    editPriceInput.value = itemToEdit.price || '';
    editDescInput.value = itemToEdit.desc || '';

    editOverlay.style.display = 'flex';
}

async function handleDeleteClick(event) {
    const itemId = event.target.dataset.id;
    if (!confirm('هل أنت متأكد من رغبتك في حذف هذا الصنف؟ لا يمكن التراجع عن هذا الإجراء.')) {
        return;
    }

    const token = getAuthToken();
    if (!token) {
        return alert('مطلوب GitHub Token لإجراء الحذف. يرجى فتح لوحة التحكم وإدخاله.');
    }
    
    try {
        const existingFile = await githubGetFile(MENU_JSON_PATH);
        if (!existingFile) throw new Error('ملف المنيو غير موجود.');

        let menu = JSON.parse(base64ToUtf8(existingFile.content.replace(/\n/g, '')));
        const updatedMenu = menu.filter(item => item.addedAt !== itemId);

        if (menu.length === updatedMenu.length) {
            throw new Error('لم يتم العثور على الصنف المراد حذفه.');
        }

        const jsonString = JSON.stringify(updatedMenu, null, 2);
        await githubPutFile(MENU_JSON_PATH, utf8ToBase64(jsonString), `Delete menu item ${itemId}`, existingFile.sha, token);

        alert('✅ تم حذف الصنف بنجاح.');
        await renderMenu();

    } catch (err) {
        console.error(err);
        alert('حدث خطأ أثناء الحذف: ' + err.message);
    }
}

saveEditBtn.addEventListener('click', async () => {
    const itemId = editIdInput.value;
    const token = getAuthToken();
    if (!token) {
        return alert('مطلوب GitHub Token لحفظ التعديلات. يرجى فتح لوحة التحكم وإدخاله.');
    }
    
    try {
        const existingFile = await githubGetFile(MENU_JSON_PATH);
        if (!existingFile) throw new Error('ملف المنيو غير موجود.');

        let menu = JSON.parse(base64ToUtf8(existingFile.content.replace(/\n/g, '')));
        const itemIndex = menu.findIndex(item => item.addedAt === itemId);
        if (itemIndex === -1) throw new Error('لم يتم العثور على الصنف.');

        // تحديث بيانات الصنف
        menu[itemIndex].category = editCatInput.value.trim();
        menu[itemIndex].name = editNameInput.value.trim();
        menu[itemIndex].price = editPriceInput.value.trim();
        menu[itemIndex].desc = editDescInput.value.trim();

        const jsonString = JSON.stringify(menu, null, 2);
        await githubPutFile(MENU_JSON_PATH, utf8ToBase64(jsonString), `Edit menu item ${menu[itemIndex].name}`, existingFile.sha, token);

        alert('✅ تم حفظ التعديلات بنجاح.');
        editOverlay.style.display = 'none';
        await renderMenu();

    } catch (err) {
        console.error(err);
        alert('حدث خطأ أثناء حفظ التعديلات: ' + err.message);
    }
});

/* ================ تعديل معلومات التواصل ================ */

async function loadInfoForEditing() {
    try {
        const file = await githubGetFile(INFO_JSON_PATH);
        if (!file) return; // لا تفعل شيئًا إذا لم يكن الملف موجودًا
        const info = JSON.parse(base64ToUtf8(file.content.replace(/\n/g, '')));
        infoAddressInput.value = info.address || '';
        infoPhoneInput.value = info.phone || '';
    } catch (err) {
        console.error('فشل تحميل المعلومات للتعديل:', err);
        alert('فشل تحميل المعلومات الحالية للتعديل.');
    }
}

saveInfoBtn.addEventListener('click', async () => {
    const token = getAuthToken();
    if (!token) {
        return alert('مطلوب GitHub Token لحفظ التعديلات.');
    }

    const newAddress = infoAddressInput.value.trim();
    const newPhone = infoPhoneInput.value.trim();

    try {
        const existingFile = await githubGetFile(INFO_JSON_PATH);
        const sha = existingFile ? existingFile.sha : null;

        const newInfo = { address: newAddress, phone: newPhone };
        const jsonString = JSON.stringify(newInfo, null, 2);
        const base64Content = utf8ToBase64(jsonString);

        await githubPutFile(INFO_JSON_PATH, base64Content, 'feat: update contact info', sha, token);

        alert('✅ تم حفظ المعلومات بنجاح.');
        infoOverlay.style.display = 'none';
        await loadAndRenderInfo(); // إعادة تحميل المعلومات على الغلاف
    } catch (err) {
        console.error('خطأ أثناء حفظ معلومات التواصل:', err);
        alert('حدث خطأ أثناء حفظ المعلومات: ' + err.message);
    }
});
/* تحويل نص UTF-8 إلى Base64 (الطريقة الحديثة) */
function utf8ToBase64(str) {
  const encoder = new TextEncoder();
  const data = encoder.encode(str);
  let binary = '';
  for (let i = 0; i < data.length; i++) {
    binary += String.fromCharCode(data[i]);
  }
  return btoa(binary);
}

/* تحويل Base64 إلى نص UTF-8 (الطريقة الحديثة) */
function base64ToUtf8(b64) {
  const binary = atob(b64);
  const bytes = new Uint8Array(binary.length);
  for (let i = 0; i < binary.length; i++) {
    bytes[i] = binary.charCodeAt(i);
  }
  const decoder = new TextDecoder('utf-8');
  return decoder.decode(bytes);
}


/* تحويل ملف إلى base64 (بدون data:prefix) */
function fileToBase64(file){
  return new Promise((res, rej)=>{
    const reader = new FileReader();
    reader.onload = ()=> {
      const result = reader.result;
      // result مثال: "data:image/png;base64,...."
      const comma = result.indexOf(',');
      res(result.substring(comma+1));
    };
    reader.onerror = e=> rej(e);
    reader.readAsDataURL(file);
  });
}

/* sanitize filename */
function makeSafeFilename(name){
  // إضافة وقت لتجنب الكتابة فوق ملف بنفس الاسم
  const ts = Date.now();
  const clean = name.replace(/[^a-zA-Z0-9\.\-_]/g, '_');
  return `${ts}_${clean}`;
}

/* ================ تهيئة العرض عند التحميل ================ */
renderMenu();

/* ================ أحداث رفع ================ */
uploadBtn.addEventListener('click', uploadItem);

/* ========= مساعدة للاختبار: مسح Token مؤقت من sessionStorage ========= */
window.clearToken = ()=> { sessionStorage.removeItem('GHTOKEN'); alert('Token cleared from sessionStorage'); }

/* ========= المساعدة النهائية: لو عايز تغير الباسورد =========
   - احسب sha256 لكلمة جديدة (يمكنك استدعاء window.sha256('newpass') في console)
   - ضَع الناتج مكان PASSWORD_HASH في بداية الكود
*/

</script>
</body>
</html>

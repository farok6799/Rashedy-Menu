<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø£Ø³Ù…Ø§Ùƒ Ø§Ù„Ø±Ø´ÙŠØ¯ÙŠ â€” Ù…Ù†ÙŠÙˆ</title>
<style>
  /* --- ØµÙØ­Ø© Ø£Ù†ÙŠÙ‚Ø© Ù„Ù„ÙƒØªØ§Ø¨ ÙˆØ§Ù„Ù…Ù†ÙŠÙˆ --- */
  :root{
    --bg:#050507; --card:#0f1114; --accent:#c9a36b; --muted:#9aa0a6;
  }
  *{box-sizing:border-box;font-family:system-ui,'Segoe UI',Tahoma,'Noto Sans Arabic',sans-serif}
  body{margin:0;min-height:100vh;background:linear-gradient(180deg,#050507,#0b0c0f);color:#fff;display:flex;align-items:center;justify-content:center;padding:30px}
  .container{width:100%;max-width:1100px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  header h1{color:var(--accent);font-size:28px;margin:0}
  .adminBtn{background:transparent;border:0;color:#fff;font-size:26px;cursor:pointer;padding:6px 10px;border-radius:8px}
  /* book */
  .bookScene{perspective:2000px;width:100%;height:560px;display:flex;align-items:center;justify-content:center}
  .book{width:760px;height:520px;position:relative;transform-style:preserve-3d}
  .cover{
    position:absolute;width:100%;height:100%;left:0;top:0;border-radius:12px;background:linear-gradient(135deg,#141414,#2b2b2b);display:flex;align-items:center;justify-content:center;z-index:10;
    color:var(--accent);font-weight:800;font-size:44px;cursor:pointer;box-shadow:0 40px 80px rgba(0,0,0,0.7);
    transform-origin:left;transition:transform 1s cubic-bezier(.22,.9,.32,1);
  }
  .book.open .cover{transform:rotateY(-180deg)}
  .pages{position:absolute;inset:0;border-radius:12px;background:#fbf8f3;color:#111;box-shadow:inset 0 6px 30px rgba(0,0,0,0.25);overflow:hidden;transform-style:preserve-3d}
  .page{position:absolute;inset:0;backface-visibility:hidden;transform-origin:left;transition:transform 900ms cubic-bezier(.22,.9,.32,1), z-index 0s 450ms;transform-style:preserve-3d}
  .page-front, .page-back {position:absolute;inset:0;padding:28px;backface-visibility:hidden;display:flex;flex-direction:column}
  .page-front{background:#fdfcf9;} /* Ø§Ù„ÙˆØ¬Ù‡ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ­Ù…Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
  .page-back{background:#fbf8f3;transform:rotateY(180deg)} /* Ø§Ù„ÙˆØ¬Ù‡ Ø§Ù„Ø®Ù„ÙÙŠ Ø§Ù„ÙØ§Ø±Øº */
  .page h2{margin:0 0 8px 0;color:#c9a36b; position: relative; z-index: 1;} /* z-index to ensure title is above grid */
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-top:10px}
  .card{background:rgba(0,0,0,0.03);padding:10px;border-radius:10px;display:flex;gap:10px;align-items:center}
  .card img{width:120px;height:80px;object-fit:cover;border-radius:8px}
  .card .meta{flex:1}
  .price{color:var(--accent);font-weight:700}
  .controls{position:fixed;right:18px;bottom:18px;display:flex;gap:8px}
  .btn{background:rgba(255,255,255,0.06);border:0;padding:10px 12px;border-radius:8px;color:var(--muted);cursor:pointer}
  /* popup styles */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:9999}
  .panel{background:#161616;padding:18px;border-radius:12px;width:360px;box-shadow:0 20px 60px rgba(0,0,0,0.8)}
  input,select,textarea{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:0;background:#222;color:#fff}
  label{color:#ddd;font-size:13px;margin-top:8px;display:block}
  .small{font-size:13px;color:#aaa;margin-top:8px}
  .danger{background:#ff4d4d;color:#111}
  footer.small{margin-top:10px;color:#888;font-size:12px}
  @media (max-width:880px){ .book{width:92vw;height:62vh} .grid{grid-template-columns:1fr} .card img{width:90px;height:70px} .panel{width:92vw} }
  #pwToggle{position:absolute;left:10px;top:50%;transform:translateY(-50%);cursor:pointer;user-select:none;}
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Ø£Ø³Ù…Ø§Ùƒ Ø§Ù„Ø±Ø´ÙŠØ¯ÙŠ</h1>
      <button class="adminBtn" id="adminBtn" title="Ø¥Ø¯Ø§Ø±Ø©">â‹®</button>
    </header>

    <div class="bookScene">
      <div class="book" id="book">
        <div class="cover" id="cover">Ø£Ø³Ù…Ø§Ùƒ Ø§Ù„Ø±Ø´ÙŠØ¯ÙŠ</div>
        <div class="pages" id="pagesArea">
          <!-- ØµÙØ­Ø§Øª Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ -->
        </div>
      </div>
    </div>

    <div class="controls">
      <button class="btn" id="prevBtn">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</button>
      <button class="btn" id="nextBtn">Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©</button>
    </div>
  </div>

  <!-- Overlay: password prompt -->
  <div class="overlay" id="passwordOverlay">
    <div class="panel">
      <h3>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
      <div style="position:relative;">
        <input type="password" id="pwInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <span id="pwToggle">ğŸ‘ï¸</span>
      </div>
      <label class="small">Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„ØªØ­ÙƒÙ… â€” ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù€ hash ÙÙŠ Ø§Ù„ÙƒÙˆØ¯</label>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="pwSubmit">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn" id="pwCancel">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
      <hr style="margin-top:12px;border:none;border-top:1px solid rgba(255,255,255,0.04)">
      <div class="small">Ù„Ùˆ Ù†Ø¬Ø­Øª Ø³ØªØ³ØªØ·ÙŠØ¹ Ø±ÙØ¹ ØµÙˆØ± ÙˆØµÙ†Ù Ø¬Ø¯ÙŠØ¯. Ø³ØªØ·Ù„Ø¨ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ Ø§Ù„Ù€ GitHub Token (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©).</div>
    </div>
  </div>

  <!-- Overlay: admin upload -->
  <div class="overlay" id="adminOverlay">
    <div class="panel">
      <h3>Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</h3>

      <label>Ø§Ù„ÙØ¦Ø©</label>
      <input id="catInput" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø³Ù…Ø§Ùƒ">

      <label>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</label>
      <input id="nameInput" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">

      <label>Ø§Ù„Ø³Ø¹Ø±</label>
      <input id="priceInput" placeholder="Ø§Ù„Ø³Ø¹Ø±">

      <label>Ø§Ù„ÙˆØµÙ</label>
      <textarea id="descInput" placeholder="ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>

      <label>Ø§Ù„ØµÙˆØ±Ø© (Ø³ÙŠØªÙ… Ø±ÙØ¹Ù‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ø±ÙŠØ¨Ùˆ)</label>
      <input type="file" id="imgInput" accept="image/*">

      <label class="small">Ø£Ø¯Ø®Ù„ GitHub Personal Access Token (Ø³ÙŠÙØ®Ø²Ù† Ù…Ø¤Ù‚ØªÙ‹Ø§ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ ÙÙ‚Ø·)</label>
      <input id="tokenInput" placeholder="ghp_xxx... (Ø£Ø¯Ø®Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ù‡Ù†Ø§ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)">

      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="uploadBtn">Ø¥Ø¶Ø§ÙØ© ÙˆØ±ÙØ¹</button>
        <button class="btn danger" id="closeAdminBtn">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>

      <footer class="small">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ØªÙˆÙƒÙ† Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø§Ù„Ø±ÙŠØ¨ÙˆØ› ØµÙ„Ø§Ø­ÙŠØ© repo ÙƒØ§ÙÙŠØ©. Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø³Ø­Ù‡ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub.</footer>
    </div>
  </div>

<script>
/* ================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø±ÙŠØ¨Ù‘Ùˆ ================== */
const GITHUB_OWNER = 'farok6799';
const GITHUB_REPO  = 'Rashedy-Menu';
const GITHUB_BRANCH = 'main'; // Ø£Ùˆ 'master' Ù„Ùˆ Ø¨ØªØ³ØªØ®Ø¯Ù…Ù‡
const MENU_JSON_PATH = 'menu.json';
const IMAGES_FOLDER = 'images/';

/* ============ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù…Ø®Ø²Ù† Ø¹Ù„Ù‰ Ø´ÙƒÙ„ Ù‡Ø§Ø´ SHA-256 ============
   Ø§Ù„Ù‚ÙŠÙ…Ø© Ù‡Ù†Ø§ ØªÙ…Ø«Ù„ hash('1234') Ø¨Ø§Ù„Ù€ SHA-256. Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯:
   Ø§Ø­Ø³Ø¨ SHA-256 Ù„ÙƒÙ„Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© (ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø£Ø¯ÙŠÙƒ Ø£Ø¯Ø§Ø© Ù„Ùˆ Ø­Ø¨ÙŠØª) ÙˆØºÙŠÙ‘Ø± Ø§Ù„Ù‚ÙŠÙ…Ø©.
   current for '1234' hashed:
*/
const PASSWORD_HASH = '03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4'; // sha256("1234")

/* ================== Ø¹Ù†Ø§ØµØ± DOM ================== */
const adminBtn = document.getElementById('adminBtn');
const passwordOverlay = document.getElementById('passwordOverlay');
const adminOverlay = document.getElementById('adminOverlay');
const pwSubmit = document.getElementById('pwSubmit');
const pwCancel = document.getElementById('pwCancel');
const pwInput = document.getElementById('pwInput');
const uploadBtn = document.getElementById('uploadBtn');
const closeAdminBtn = document.getElementById('closeAdminBtn');
const tokenInput = document.getElementById('tokenInput');

const nameInput = document.getElementById('nameInput');
const priceInput = document.getElementById('priceInput');
const descInput = document.getElementById('descInput');
const catInput = document.getElementById('catInput');
const imgInput = document.getElementById('imgInput');

const pagesArea = document.getElementById('pagesArea');
const cover = document.getElementById('cover');
const book = document.getElementById('book');
const nextBtn = document.getElementById('nextBtn');
const prevBtn = document.getElementById('prevBtn');

let currentPageIndex = -1; // -1 means cover visible
let pages = []; // array of category pages

/* ========== Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø­Ø³Ø§Ø¨ SHA-256 Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Crypto ========= */
async function sha256(text){
  const enc = new TextEncoder();
  const data = enc.encode(text);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}

/* ========== ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ overlays ========== */
adminBtn.addEventListener('click', ()=> {
  if (!window.crypto || !window.crypto.subtle) {
    alert('Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.\n\nØ§Ù„Ø³Ø¨Ø¨: Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªØ¹Ù…Ù„ Ù…Ù† Ø®Ù„Ø§Ù„ Ø®Ø§Ø¯Ù… ÙˆÙŠØ¨ (localhost Ø£Ùˆ https) ÙˆÙ„ÙŠØ³ ÙƒÙ…Ù„Ù Ù…Ø¨Ø§Ø´Ø±.\n\nØ§Ù„Ø­Ù„: Ø§Ø³ØªØ®Ø¯Ù… Ø¥Ø¶Ø§ÙØ© "Live Server" ÙÙŠ VS Code Ù„ØªØ´ØºÙŠÙ„Ù‡Ø§.');
    return;
  }
  passwordOverlay.style.display = 'flex';
});
pwCancel.addEventListener('click', ()=> passwordOverlay.style.display = 'none');

/* ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ (Ù…Ù‚Ø§Ø±Ù†Ø© Ù‡Ø§Ø´) */
pwSubmit.addEventListener('click', async ()=> {
  const tryHash = await sha256((pwInput.value || '').trim());
  // --- Ø³Ø·Ø± Ø§Ù„ØªØ´Ø®ÙŠØµ: Ø§Ø·Ø¨Ø¹ Ø§Ù„Ù‡Ø§Ø´ Ø§Ù„Ø°ÙŠ ØªÙ… Ø­Ø³Ø§Ø¨Ù‡ ÙˆØ§Ù„Ù‡Ø§Ø´ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© ---
  console.log('Ø§Ù„Ù‡Ø§Ø´ Ø§Ù„Ø°ÙŠ Ø£Ø¯Ø®Ù„ØªÙ‡:', tryHash, '\nØ§Ù„Ù‡Ø§Ø´ Ø§Ù„ØµØ­ÙŠØ­:', PASSWORD_HASH);
  if(tryHash === PASSWORD_HASH){
    passwordOverlay.style.display = 'none';
    adminOverlay.style.display = 'flex';
    // Ù…Ù…ÙƒÙ† Ø£Ù† Ù†Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù† sessionStorage Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¯Ø®Ù„Ù‡ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡
    tokenInput.value = sessionStorage.getItem('GHTOKEN') || '';
  } else {
    alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø·Ø£!');
  }
});

/* Ø¥ØºÙ„Ø§Ù‚ admin */
closeAdminBtn.addEventListener('click', ()=> {
  adminOverlay.style.display = 'none';
});

/* Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± */
const pwToggle = document.getElementById('pwToggle');
pwToggle.addEventListener('click', () => {
  const isPassword = pwInput.type === 'password';
  pwInput.type = isPassword ? 'text' : 'password';
  pwToggle.textContent = isPassword ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
});

/* ================= GitHub API helpers ================= */

/* Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ù…Ù† GitHub (Ù…Ø­ØªÙˆÙ‰ base64 + sha) */
async function githubGetFile(path){
  const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodeURIComponent(path)}?ref=${GITHUB_BRANCH}`;
  const res = await fetch(url);
  if(res.status === 200){
    const data = await res.json();
    return data; // { content (base64), sha, path, ... }
  } else if(res.status === 404){
    return null;
  } else {
    const t = await res.text();
    throw new Error('GitHub GET error: ' + res.status + ' - ' + t);
  }
}

/* Ø±ÙØ¹/ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù Ø¥Ù„Ù‰ GitHub (ÙŠØªØ·Ù„Ø¨ ØªÙˆÙƒÙ†) */
async function githubPutFile(path, base64content, message, sha=null, token){
  const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodeURIComponent(path)}`;
  const body = { message, content: base64content, branch: GITHUB_BRANCH };
  if(sha) body.sha = sha;
  const res = await fetch(url, {
    method:'PUT',
    headers: {
      'Authorization': 'token ' + token,
      'Accept': 'application/vnd.github.v3+json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(body)
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error('GitHub PUT error: ' + res.status + ' - ' + t);
  }
  return await res.json();
}

/* ØªØ­Ù…ÙŠÙ„ menu.json Ù…Ù† Ø§Ù„Ø±ÙŠØ¨Ùˆ ÙƒÙ€ object */
async function loadMenuJson(){
  try{
    const file = await githubGetFile(MENU_JSON_PATH);
    if(!file) return [];
    const jsonString = base64ToUtf8(file.content.replace(/\n/g,'')); // ÙÙƒ ØªØ±Ù…ÙŠØ² Base64 Ù…Ø¹ Ø¯Ø¹Ù… UTF-8
    return JSON.parse(jsonString);
  }catch(err){
    console.error(err);
    return [];
  }
}

/* Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ÙŠÙˆ: Ù†Ù‚Ø³Ù… Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø§Øª */
async function renderMenu(){
  const menu = await loadMenuJson();
  // group by category
  const cats = {};
  for(const it of menu){
    const c = it.category || 'ØºÙŠØ± Ù…ØµÙ†Ù';
    if(!cats[c]) cats[c] = [];
    cats[c].push(it);
  }

  // Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ù‡: ÙƒÙ„ ÙØ¦Ø© ØµÙØ­Ø©
  pagesArea.innerHTML = '';
  pages = [];
  for(const [cat, items] of Object.entries(cats)){
    const page = document.createElement('div');
    page.className = 'page'; // Ù„Ø§ ØªØ¶Ø¹ padding Ù‡Ù†Ø§
    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¬Ù‡ÙŠÙ† Ù„Ù„ØµÙØ­Ø©
    page.innerHTML = `
      <div class="page-front">
        <h2>${escapeHtml(cat)}</h2>
        <div class="grid"></div>
      </div>
      <div class="page-back"></div>
    `;
    const grid = page.querySelector('.page-front .grid');
    for(const it of items){
      const card = document.createElement('div');
      card.className = 'card';
      const imgUrl = it.image || '';
      card.innerHTML = `
        <img 
          src="${imgUrl}" 
          alt="${escapeHtml(it.name)}" 
          loading="lazy" 
          onerror="this.style.display='none'"
        >
        <div class="meta">
          <div style="font-weight:700">${escapeHtml(it.name)}</div>
          <div style="color:#888;font-size:13px">${escapeHtml(it.desc||'')}</div>
          <div class="price">${escapeHtml(it.price)}</div>
        </div>
      `;
      grid.appendChild(card);
    }
    pagesArea.appendChild(page);
    pages.push(page);
  }

  // Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ù„Ùˆ Ù…ÙÙŠØ´ ØµÙØ­Ø§Øª Ø§Ø¨Ù‚Ù Ø§Ù„ØºÙ„Ø§Ù Ø¸Ø§Ù‡Ø± ÙÙ‚Ø·
  currentPageIndex = -1;
  applyFlipState();
}

/* ØªØ¹Ø§Ø¨ÙŠØ± Ù…Ø³Ø§Ø¹Ø¯Ø© */
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

/* ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØµÙØ­Ø§Øª (ØªÙ‚Ù„ÙŠØ¨) */
function applyFlipState(){
  const total = pages.length;
  // currentPageIndex Ù‡Ùˆ Ù…Ø¤Ø´Ø± Ø¢Ø®Ø± ØµÙØ­Ø© ØªÙ… Ù‚Ù„Ø¨Ù‡Ø§. -1 ÙŠØ¹Ù†ÙŠ Ø§Ù„ØºÙ„Ø§Ù Ù…ØºÙ„Ù‚.
  // 0 ÙŠØ¹Ù†ÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù…Ù‚Ù„ÙˆØ¨Ø©ØŒ ÙˆÙ†Ø±Ù‰ Ø¸Ù‡Ø±Ù‡Ø§ ÙˆÙˆØ¬Ù‡ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©.
  pages.forEach((page, i) => {
    const isFlipped = i <= currentPageIndex;
    const isCurrentVisiblePage = i === currentPageIndex + 1;

    page.style.transform = isFlipped ? 'rotateY(-180deg)' : 'rotateY(0deg)';
    
    // z-index: Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ù‚Ù„ÙˆØ¨Ø© ØªØ£Ø®Ø° ØªØ±ØªÙŠØ¨ ØªØµØ§Ø¹Ø¯ÙŠ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„.
    // Ø§Ù„ØµÙØ­Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ù‚Ù„ÙˆØ¨Ø© ØªØ£Ø®Ø° ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰.
    page.style.zIndex = isFlipped ? i + 1 : total - i;

    // Ø§Ù„Ø£Ù‡Ù…: Ù†Ù…Ù†Ø¹ ØªØ¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
    page.style.transformStyle = isCurrentVisiblePage ? 'preserve-3d' : 'flat';
  });
  book.classList.toggle('open', currentPageIndex > -1); // Ø§ÙØªØ­ Ø§Ù„ÙƒØªØ§Ø¨ Ù„Ùˆ Ø£ÙŠ ØµÙØ­Ø© Ù…Ù‚Ù„ÙˆØ¨Ø©
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ§Ù„ÙŠ / Ø§Ù„Ø³Ø§Ø¨Ù‚ */
nextBtn.addEventListener('click', ()=> {
  if(currentPageIndex < pages.length - 1) currentPageIndex++;
  applyFlipState();
});
prevBtn.addEventListener('click', ()=> {
  if(currentPageIndex > -1) currentPageIndex--;
  applyFlipState();
});
cover.addEventListener('click', ()=> {
  // Ø§Ø¶ØºØ· Ø§Ù„ØºÙ„Ø§Ù ÙŠÙØªØ­Ù‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
  if(pages.length>0){
    currentPageIndex = 0;
    applyFlipState();
  }
});

/* ============== Ø±ÙØ¹ ØµÙˆØ±Ø© ÙˆØ­Ø¯Ø« menu.json ============== */
async function uploadItem(){
  const name = nameInput.value.trim();
  const price = priceInput.value.trim();
  const desc = descInput.value.trim();
  const category = (catInput.value.trim() || 'ØºÙŠØ± Ù…ØµÙ†Ù');
  const file = imgInput.files[0];
  const token = tokenInput.value.trim() || sessionStorage.getItem('GHTOKEN');

  if(!name || !price || !file){
    return alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒÙ…Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø³Ø¹Ø± ÙˆØ§Ø®ØªØ± ØµÙˆØ±Ø©.');
  }
  if(!token){
    return alert('Ø§Ø­ØªØ§Ø¬ GitHub Token Ø¹Ø´Ø§Ù† Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ù‘Ø« menu.json. Ø¶Ø¹Ù‡ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø£Ùˆ Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¤Ù‚ØªÙ‹Ø§.');
  }

  try{
    // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ø¤Ù‚ØªØ§Ù‹ ÙÙŠ sessionStorage (Ù…Ø±ÙŠØ­ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©)
    sessionStorage.setItem('GHTOKEN', token);

    // 1) Ù†Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ images/<filename>
    const filename = makeSafeFilename(file.name);
    const targetPath = IMAGES_FOLDER + filename;

    // Ø§Ù‚Ø±Ø£ Ø§Ù„Ù…Ù„Ù ÙƒÙ€ base64
    const base64 = await fileToBase64(file); // returns base64 string without data:...
    await githubPutFile(targetPath, base64, `Add image ${filename}`, null, token);
    // Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ù†ÙƒÙˆÙ‘Ù† Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø®Ø§Ù… Ù„Ù„ØµÙˆØ±Ø©:
    const rawUrl = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${targetPath}`;

    // 2) Ù†Ù‚Ø±Ø£ menu.json Ø§Ù„Ø­Ø§Ù„ÙŠ
    const existingFile = await githubGetFile(MENU_JSON_PATH);
    let menu = [];
    let sha = null;
    if(existingFile && existingFile.content){ // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù ÙˆÙ…Ø­ØªÙˆØ§Ù‡
      sha = existingFile.sha;
      menu = JSON.parse(base64ToUtf8(existingFile.content.replace(/\n/g,'')));
    } else {
      menu = [];
    }

    // 3) Ù†Ø¶ÙŠÙ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const newItem = { name, price, desc, category, image: rawUrl, addedAt: new Date().toISOString() };
    menu.push(newItem);

    // 4) Ù†Ø±ÙØ¹ menu.json Ù…Ø¹ sha Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
    const jsonString = JSON.stringify(menu, null, 2);
    await githubPutFile(MENU_JSON_PATH, utf8ToBase64(jsonString), `Add menu item ${name}`, sha, token);

    alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ø§Ù„Ø±ÙŠØ¨Ùˆ!');
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
    nameInput.value = priceInput.value = descInput.value = '';
    catInput.value = '';
    imgInput.value = '';
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶
    await renderMenu();

  }catch(err){
    console.error(err);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹: ' + err.message);
  }
}

/* ØªØ­ÙˆÙŠÙ„ Ù†Øµ UTF-8 Ø¥Ù„Ù‰ Base64 (Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­Ø¯ÙŠØ«Ø©) */
function utf8ToBase64(str) {
  const encoder = new TextEncoder();
  const data = encoder.encode(str);
  let binary = '';
  for (let i = 0; i < data.length; i++) {
    binary += String.fromCharCode(data[i]);
  }
  return btoa(binary);
}

/* ØªØ­ÙˆÙŠÙ„ Base64 Ø¥Ù„Ù‰ Ù†Øµ UTF-8 (Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­Ø¯ÙŠØ«Ø©) */
function base64ToUtf8(b64) {
  const binary = atob(b64);
  const bytes = new Uint8Array(binary.length);
  for (let i = 0; i < binary.length; i++) {
    bytes[i] = binary.charCodeAt(i);
  }
  const decoder = new TextDecoder('utf-8');
  return decoder.decode(bytes);
}


/* ØªØ­ÙˆÙŠÙ„ Ù…Ù„Ù Ø¥Ù„Ù‰ base64 (Ø¨Ø¯ÙˆÙ† data:prefix) */
function fileToBase64(file){
  return new Promise((res, rej)=>{
    const reader = new FileReader();
    reader.onload = ()=> {
      const result = reader.result;
      // result Ù…Ø«Ø§Ù„: "data:image/png;base64,...."
      const comma = result.indexOf(',');
      res(result.substring(comma+1));
    };
    reader.onerror = e=> rej(e);
    reader.readAsDataURL(file);
  });
}

/* sanitize filename */
function makeSafeFilename(name){
  // Ø¥Ø¶Ø§ÙØ© ÙˆÙ‚Øª Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙˆÙ‚ Ù…Ù„Ù Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…
  const ts = Date.now();
  const clean = name.replace(/[^a-zA-Z0-9\.\-_]/g, '_');
  return `${ts}_${clean}`;
}

/* ================ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ================ */
renderMenu();

/* ================ Ø£Ø­Ø¯Ø§Ø« Ø±ÙØ¹ ================ */
uploadBtn.addEventListener('click', uploadItem);

/* ========= Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±: Ù…Ø³Ø­ Token Ù…Ø¤Ù‚Øª Ù…Ù† sessionStorage ========= */
window.clearToken = ()=> { sessionStorage.removeItem('GHTOKEN'); alert('Token cleared from sessionStorage'); }

/* ========= Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØºÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ =========
   - Ø§Ø­Ø³Ø¨ sha256 Ù„ÙƒÙ„Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© (ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ window.sha256('newpass') ÙÙŠ console)
   - Ø¶ÙØ¹ Ø§Ù„Ù†Ø§ØªØ¬ Ù…ÙƒØ§Ù† PASSWORD_HASH ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØ¯
*/

</script>
</body>
</html>
